<?php

/**
 * @file
 * Tests for the blocks on home page.
 */

/**
 * Tests menu links depending on user permissions.
 */
class PestSampler_Finish_Registered_TestCase extends FirstRemoteTestCase {
  public static function getInfo() {
    return array(
      'name' => 'Pest Sampler Finish Registered Test',
      'description' => 'Tests finish page of the Pest Sampler wizard when logged in',
      'group' => 'iWheat',
    );
  }

  function setUp() {
    parent::setUp(array('node'));
  }

  /**
   * Test that the links are added to the page (no JS testing).
   */
  function testSamplerFinish() {
    module_enable(array('contact'));
    $this->resetAll();
    
    if ($this->loggedInUser) {
      $this->drupalLogout();
    }

    $edit = array(
      'name' => '',
      'pass' => ''
    );
    
    $this->drupalPost('user', $edit, 'Log in');

    // If a "log out" link appears on the page, it is almost certainly because
    // the login was successful.
    $pass = $this->assertLink('Log Out', 0, 'User successfully logged in.', 'Other');

    // Check section header and home page link to ensure they are correct
    $this->drupalGet('http://dev.iwheat.org/pest_sampler/nojs');
    
    $this->setUpSampler();
    $this->checkMapPage();
  }
  
  function setUpSampler()
  {
    $edit = array('field_samples_method[und]' => t('5114'));
    $this->drupalPost(NULL, $edit, t('Continue'));
    $this->assertElementByXPath('//div[@id="edit-field-samples-location"]', array(), 'The map was displayed after first page');
  }
  function checkFinishPage()
  {
    $base_path = '//div[@id="block-system-main"]//div[@class="block-inner clearfix"]//div[@class="content clearfix"]//div[@id="wizard-form-wrapper"]//form[@id="pest-sampler-wizard-step-form"]//div';
  
    //Check that the wizard "trail" section displays correctly
    $this->assertFieldByXPath($base_path . '//div[@class="wizard-trail"]//span', 'Method', 'Wizard Trail 1st Step display correct.');
    $this->assertFieldByXPath($base_path . '//div[@class="wizard-trail"]//span', 'Location', 'Wizard Trail 2nd Step display correct.');
    $this->assertFieldByXPath($base_path . '//div[@class="wizard-trail"]//span', 'Site', 'Wizard Trail 3rd Step display correct.');
    $this->assertFieldByXPath($base_path . '//div[@class="wizard-trail"]//span', 'Costs', 'Wizard Trail 4rd Step display correct.');
    $this->assertFieldByXPath($base_path . '//div[@class="wizard-trail"]//span', 'Samples', 'Wizard Trail 5th Step display correct.');
    $this->assertFieldByXPath($base_path . '//div[@class="wizard-trail"]//span', 'Notes', 'Wizard Trail 6th Step display correct.');
    $this->assertFieldByXPath($base_path . '//div[@class="wizard-trail"]//span', 'Finish', 'Wizard Trail 7th Step display correct.');   
    
    //checks for code up to the asserts below
    $base_path = '//div[@id="block-system-main"]//div[@class="block-inner clearfix"]//div[@class="content clearfix"]//div[@id="wizard-form-wrapper"]//form[@id="pest-sampler-wizard-step-form"]//div';
    
    //Check that the Continue, Back, and Cancel buttons appear
    $this->assertElementByXPath($base_path . '//div//input[contains(@id, "edit-buttons-next")]', array(), 'Continue button displays correctly.');
    $this->assertElementByXPath($base_path . '//div//input[contains(@id, "edit-buttons-previous")]', array(), 'Back button displays correctly.');
    $this->assertElementByXPath($base_path . '//div//input[contains(@id, "edit-buttons-cancel")]', array(), 'Cancel button displays correctly.');
  }
}
