<?php

/**
 * @file
 * Tests for the blocks on home page.
 */

/**
 * Tests menu links depending on user permissions.
 */
class PestSampler_SampleMethod_Registered_TestCase extends FirstRemoteTestCase {
  public static function getInfo() {
    return array(
      'name' => 'Pest Sampler Sampling Method Registered Test',
      'description' => 'Tests first page of the Pest Sampler wizard when logged in',
      'group' => 'iWheat',
    );
  }

  function setUp() {
    parent::setUp(array('node'));
  }

  /**
   * Test that the links are added to the page (no JS testing).
   */
  function testSamplerFirstPage() {
    module_enable(array('contact'));
    $this->resetAll();
    
    if ($this->loggedInUser) {
      $this->drupalLogout();
    }

    $edit = array(
      'name' => 'dgk2010',
      'pass' => 'thisIsATestPassword'
    );
    
    $this->drupalPost('user', $edit, 'Log in');

    // If a "log out" link appears on the page, it is almost certainly because
    // the login was successful.
    $pass = $this->assertLink('Log Out', 0, 'User successfully logged in.', 'Other');

    // Check section header and home page link to ensure they are correct
    $this->drupalGet('http://dev.iwheat.org/pest_sampler/nojs');
    
    $this->checkPageFields();
  }
  
   
  function checkPageFields() {
  
    $base_path = '//div[@id="block-system-main"]//div[@class="block-inner clearfix"]//div[@class="content clearfix"]//div[@id="wizard-form-wrapper"]//form[@id="pest-sampler-wizard-step-form"]//div';
  
    //Check that the wizard "trail" section displays correctly
    $this->assertFieldByXPath($base_path . '//div[@class="wizard-trail"]//span', 'Method', 'Wizard Trail 1st Step display correct.');
    $this->assertFieldByXPath($base_path . '//div[@class="wizard-trail"]//span', 'Location', 'Wizard Trail 2nd Step display correct.');
    $this->assertFieldByXPath($base_path . '//div[@class="wizard-trail"]//span', 'Site', 'Wizard Trail 3rd Step display correct.');
    $this->assertFieldByXPath($base_path . '//div[@class="wizard-trail"]//span', 'Notes', 'Wizard Trail 4th Step display correct.');
    $this->assertFieldByXPath($base_path . '//div[@class="wizard-trail"]//span', 'Finish', 'Wizard Trail 5th Step display correct.');
    
    $base_path = $base_path . '//fieldset[@id="edit-step"]//div[@class="fieldset-wrapper"]';
    
    // Check that the Sampling Method dropdown and header display correctly
    $this->assertFieldByXPath($base_path . '//div[@id="edit-field-samples-method"]//div//label[@for="edit-field-samples-method-und"]', 'Sampling Method ', 'Sampling Method Dropdown Header display correct.');
    $this->assertField('edit-field-samples-method-und', '- None -');
    $this->assertFieldByXPath($base_path . '//div[@id="edit-field-samples-method"]//div//select[@id="edit-field-samples-method-und"]//option', '- None -', 'Sampling Method Dropdown default option display correct.');
    $this->assertFieldByXPath($base_path . '//div[@id="edit-field-samples-method"]//div//select[@id="edit-field-samples-method-und"]//option', 'Glance N Go (Greenbug)', 'Sampling Method Dropdown option 1 display correct.');
    $this->assertFieldByXPath($base_path . '//div[@id="edit-field-samples-method"]//div//select[@id="edit-field-samples-method-und"]//option', 'Wheat Stem Sawfly', 'Sampling Method Dropdown option 2 display correct.');
    $this->assertFieldByXPath($base_path . '//div[@id="edit-field-samples-method"]//div//select[@id="edit-field-samples-method-und"]//option', 'Russian Wheat Aphid...Coming Soon!', 'Sampling Method Dropdown option 3 display correct.');
    
    // Check that the Show Method Description checkbox displays correctly
    $this->assertFieldByXPath($base_path . '//div//label[@for="show-method-enabled"]', 'Show method description ', 'Show Method Description checkbox description display correct.');
    $this->assertElementByXPath($base_path . '//div//input[@id="show-method-enabled"]', array(), 'Show Method Description checkbox display correct.');
    
    /* TODO: Need Jim's help to figure out a way to select/input one field at a time
    // Select a method, select the checkbox, and check that the description displays correctly
    $this->setField('edit-field-samples-method-und', 'Glance N Go (Greenbug)');
    $this->setField('show-method-enabled', true);
    
    $this->assertFieldByXPath('//h2[@class="node-title"]//a[@href="/green-bug-sampling-method"]', 'Glance N Go (Greenbug)', 'Method Description Title Link display correct.');
    $this->assertFieldByXPath('//div[@class="content clearfix"]//div', "
    A presence/absence sampling method to make a treatment decision for greenbugs in winter wheat. First, sampling information is linked to a location or field site. Then, an economic threshold is determined by choosing the cost of treatment per acre ($/acre), and the expected value of the crop in $/bu. This economic threshold is then used to sample a minimum number of tillers for both live greenbugs and parasitized greenbugs (mummies, to account for biocontrol services working in the field). A treatment decision is provided in the report page of the sampler, which can be printed out and is automatically saved to a field site's history.  ", 'Method Description display correct.');
    
    $xpath = '//div';
    $url = 'greenbug-wizard-image.png';
    $this->assertImage($xpath, $url, 0, 'Found image with file name', $group = 'Special');  
    */
    $base_path = '//div[@id="block-system-main"]//div[@class="block-inner clearfix"]//div[@class="content clearfix"]//div[@id="wizard-form-wrapper"]//form[@id="pest-sampler-wizard-step-form"]//div';
    
    //Check that the Continue and Cancel buttons appear
    $this->assertElementByXPath($base_path . '//div//input[@value="Continue"]', array(), 'Continue button displays correctly.');
    $this->assertElementByXPath($base_path . '//div//input[@value="Cancel"]', array(), 'Cancel button displays correctly.');
    
    // Select the Continue button and verify that the Location page appears
    $edit = array('field_samples_method[und]' => t('5114'));
    $this->drupalPost(NULL, $edit, t('Continue'));
    $this->assertElementByXPath('//div[@id="edit-field-samples-location"]', array(), 'The map was displayed after clicking Continue.');
    
    // Return to the first page
    $edit = array();
    $this->drupalPost(NULL, $edit, t('Back'));
    $this->assertText('Show method description');
    
    // Click the Cancel button and check that you are redirected to the home page.
    $edit = array('field_samples_method[und]' => t('5114'));
    $this->drupalPost(NULL, $edit, t('Cancel'));
    $this->assertFieldByXPath('//h1[@id="page-title"]', 'Welcome to iWheat.org!', 'Home page title was displayed after clicking Cancel.');
  }
  
}
